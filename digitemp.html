<!DOCTYPE html>
<!--[if lt IE 7 ]><html class="ie ie6" lang="en"> <![endif]-->
<!--[if IE 7 ]><html class="ie ie7" lang="en"> <![endif]-->
<!--[if IE 8 ]><html class="ie ie8" lang="en"> <![endif]-->
<!--[if (gte IE 9)|!(IE)]><!--><html lang="en"> <!--<![endif]-->
<head>

	<!-- Basic Page Needs
  ================================================== -->
	<meta charset="utf-8">
	<title>HOW-TO digitemp</title>
	<meta name="description" content="How to measure ambient temperature with wireless router">
	<meta name="author" content="Valentino Sefer">

	<!-- Mobile Specific Metas
  ================================================== -->
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<!-- CSS
  ================================================== -->
	<link rel="stylesheet" href="stylesheets/base.css">
	<link rel="stylesheet" href="stylesheets/skeleton.css">
	<link rel="stylesheet" href="stylesheets/layout.css">

	<!--[if lt IE 9]>
		<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->

	<!-- Favicons
	================================================== -->
	<link rel="shortcut icon" href="images/favicon.ico">
	<link rel="apple-touch-icon" href="images/apple-touch-icon.png">
	<link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">

</head>
<body>



	<!-- Primary Page Layout
	================================================== -->

	<!-- Delete everything in this .container and get started on your own site! -->

	<div class="container">
		<div class="sixteen columns">
		<h1 class="remove-bottom" style="margin-top: 40px"><a href="http://fabrikator.org" style="color: black; ">vsefer@root: # <span class="blink">_</span></a></h1>
			<h7>personal blog about linux, servers, system administration, wireless, electronics ...</h7>
			<hr />
		</div>
		<div class="sixteen columns">
			<h3>How to measure ambient temperature with wireless router</h3>
			<br>

<!-- Article ========================================================= -->
<p>Measuring of ambient temperature is done with cheap Dallas sensor DS18B20 (~ 1$) over USB 2.0 to UART TTL 6PIN Module Serial Converter CP2102 (~1,50 $) and is showing temperature on simple static html web page hosted on wireless router TP-Link WR703N (~ 25$). We need wireless router TP-Link WR703N with OpenWrt image on it. If you don&#39;t know how to flash with OpenWrt image, take a look on great OpenWrt <a href="http://wiki.openwrt.org/toh/tp-link/tl-wr703n">Wiki</a> page.<br />
<br />
<strong>Simple electronic circuit</strong><br />
<br />
You can order USB 2.0 to UART TTL 6PIN Module Serial Converter CP2102 from e-bay and Dallas sensor DS18B20 from <a href="http://www.maxim-ic.com/datasheet/index.mvp/id/2812/t/or#f">Maxim-IC</a> (or you can acquire one free sample :)<br />
<br />
- connect GND and +5V to DS18B20<br />
- connect RX and TX together and to the data line of 1-wire sensor DS18B20<br />
- that&#39;s all :)</p>

<p style="text-align:left"><img alt="" class="aligncenter" src="http://haklabos.files.wordpress.com/2012/10/uart_ds18b201.png" style="border:3px solid #f3f3f3; height:308px; width:485px" title="uart_ds18b20" /></p>

<p><strong>Installing OpenWrt package/driver for UART CP2102 USB module</strong><br />
<br />
On fresh OpenWrt installation, upgrade and install required package:</p>

<pre>
<strong>opkg update &amp;&amp; opkg </strong><strong>install kmod-usb-serial-cp210x</strong>
</pre>

<p><br />
Installing digitemp package for reading temperature from the sensor</p>

<pre>
<strong>opkg install digitemp</strong></pre>

<p><br />
Initializing sensor</p>

<pre>
<strong>digitemp_DS9097 -i -s /dev/ttyUSB0</strong>
</pre>

<p><br />
Execute next command to find your UART location/path.</p>

<pre>
<strong>ls /dev/ | grep ttyUSB</strong></pre>

<p><br />
You should get output like this:</p>

<pre>
DigiTemp v3.5.0 Copyright 1996-2007 by Brian C. Lane
GNU Public License v2.0 - http://www.digitemp.com
Turning off all DS2409 Couplers
.
Searching the 1-Wire LAN
28CBC89A0300007B : DS18B20 Temperature Sensor
ROM #0 : 28CBC89A0300007B
Wrote .digitemprc</pre>

<p><br />
Reading temperature from the sensor</p>

<pre>
<strong>digitemp_DS9097 -a</strong></pre>

<p><br />
You should get output like this:</p>

<pre>
DigiTemp v3.5.0 Copyright 1996-2007 by Brian C. Lane
GNU Public License v2.0 - http://www.digitemp.com
Jun 25 21:19:55 Sensor 0 C:26.06 F: 78.91</pre>

<p><br />
<strong>Adding some startup commands</strong><br />
<br />
Edit <strong>/etc/rc.local</strong> file to add some startup command which initiates sensor after every reboot. You can edit it with included <strong>vi</strong> editor, or you can install <strong>nano</strong> editor with:</p>

<pre>
<strong>opkg install nano</strong></pre>

<p><br />
Now edit /etc/rc.local file</p>

<pre>
<strong>nano /etc/rc.local</strong></pre>

<p><br />
and add this line:</p>

<pre>
# Put your custom commands here that should be executed once
# the system init finished. By default this file does nothing.

<strong>sleep 60 &amp;&amp; digitemp_DS9097 -i -s /dev/ttyUSB0
exit 0</strong></pre>

<p><br />
After modification, press Ctrl+X, accept with Y, and press Enter ...<br />
<br />
Sleep 60, add 60 seconds pause before executing digitemp command.<br />
<br />
<strong>Install uhttpd web server and make it run on startup</strong><br />
<br />
Install with:</p>

<pre>
<strong>opkg install uhttpd</strong></pre>

<p><br />
Enable with:</p>

<pre>
<strong>/etc/init.d/uhttpd enable</strong></pre>

<p><br />
Manually start with:</p>

<pre>
<strong>/etc/init.d/uhttpd start</strong>
</pre>

<p><br />
<strong>Making simple html page</strong><br />
<br />
Create simple html web page which will show temperature.</p>

<pre>
<strong>cd /www &amp;&amp; nano index.html</strong></pre>

<p><br />
Copy/paste below code:</p>

<pre>
 &lt;html&gt;
        &lt;head&gt;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;title&gt;Temperature&lt;/title&gt;
&nbsp; &nbsp; &nbsp; &nbsp; &lt;/head&gt;
&nbsp; &nbsp; &nbsp; &nbsp; &lt;body bgcolor=&quot;#222222&quot;&gt;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;table align=&quot;center&quot; border=&quot;0&quot; cellpadding=&quot;0&quot; cellspacing=&quot;0&quot;&gt;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;tbody&gt;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;tr&gt;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;td style=&quot;text-align: center; &quot;&gt;&lt;span style=&quot;color:#696969;&quot;&gt;&lt;span style=&quot;font-size: 90px; &quot;&gt;&lt;strong&gt;&lt;span style=&quot;font-family: verdana, geneva, sans-serif; &quot;&gt;Temperature [&amp;deg;C]&lt;/span&gt;&lt;/strong&gt;&lt;/span&gt;&lt;/span&gt;&lt;/td&gt;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;/tr&gt;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;tr&gt;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;td style=&quot;text-align: center; &quot;&gt;&lt;span style=&quot;color:#66cc00;&quot;&gt;&lt;span style=&quot;font-size:300px;&quot;&gt;&lt;span style=&quot;font-family: verdana, geneva, sans-serif; &quot;&gt;27.13&lt;/span&gt;&lt;/span&gt;&lt;/td&gt;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;/tr&gt;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;/tbody&gt;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;/table&gt;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;p&gt;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;nbsp;&lt;/p&gt;
&nbsp; &nbsp; &nbsp; &nbsp; &lt;/body&gt;
&lt;/html&gt;</pre>

<p><br />
After modification press Ctrl+X, accept with Y, and press Enter &hellip;<br />
<br />
<strong>Getting and adding sensor data (temperature) to html page</strong><br />
<br />
We will use default cron service to get data from the sensor and to refresh html page with current data every minute.<br />
<br />
Edit <strong>/etc/crontabs/root</strong> with:</p>

<pre>
<strong>nano /etc/crontabs/root</strong></pre>

<p><br />
Add this line:</p>

<pre>
<strong>&nbsp;*/1* * * * TEMP=&#39;digitemp_DS9097 -a | grep -i sensor | awk &#39;{print $7}&#39;&#39;; sed -i -r &quot;14s,&gt;[^&lt;]*&lt;/,&gt;${TEMP}&lt;/,&quot; /www/index.html</strong></pre>

<p><br />
After modification, press Ctrl+X, accept with Y, and press Enter &hellip;<br />
<br />
Restart<strong> cron</strong> service:</p>

<pre>
<strong>/etc/init.d/cron restart</strong></pre>

<p><br />
Now open your browser and enter IP adress of your router (example: <a href="http://192.168.100.1/">http://192.168.100.1</a>) and you should get something like this:<br />
&nbsp;</p>

<p style="text-align:left"><a href="http://haklabos.files.wordpress.com/2012/10/www_page.png" title=" "><img alt="" class="aligncenter" src="http://haklabos.files.wordpress.com/2012/10/www_page.png" style="border:3px solid white; height:474px; width:652px" title="www_page" /></a></p>

<p><br />
That&#39;s it folks :)<br />
&nbsp;</p>
<!-- End of Article ================================================== -->
		<hr />
		<footer class="sixteen columns">
		<p>2014 | Built on <a href="http://getskeleton.com/">Skeleton</a> framework</p>
		</footer>
		</div>
	</div><!-- container -->


<!-- End Document
================================================== -->
<a href="#" class="scrollToTop">Top</a>
<a href="http://fabrikator.org" class="goToHome">Home</a>
</body>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<script src="js/jquery-blink.js" language="javascript" type="text/javascript"></script>

<script type="text/javascript" language="javascript">
$(document).ready(function()
{
	$('.blink').blink();
});
</script>

<script type="text/javascript" language="javascript">
$(document).ready(function(){
	
	//Check to see if the window is top if not then display button
	$(window).scroll(function(){
		if ($(this).scrollTop() > 100) {
			$('.scrollToTop').fadeIn();
		} else {
			$('.scrollToTop').fadeOut();
		}
	});
	
	//Click event to scroll to top
	$('.scrollToTop').click(function(){
		$('html, body').animate({scrollTop : 0},800);
		return false;
	});
	
});
</script>

<script type="text/javascript" language="javascript">
$(document).ready(function(){
	
	//Check to see if the window is top if not then display button
	$(window).scroll(function(){
		if ($(this).scrollTop() > 100) {
			$('.goToHome').fadeIn();
		} else {
			$('.goToHome').fadeOut();
		}
	});
	
});
</script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-53726523-1', 'auto');
  ga('send', 'pageview');

</script>
</html>

